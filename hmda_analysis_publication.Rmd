---
title: "2023 HMDA data analysis"
author: "JH Yoon"
date: "`r Sys.Date()`"
output:
  github_document:
    toc: true
    toc_depth: 2
    df_print: tibble
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(data.table); library(dplyr); library(ggplot2)
library(scales); library(janitor); library(ggpubr); library(flextable)
library(tidyr); library(readxl); library(plotly); library(lubridate)
library(purrr); library(zoo); library(gridExtra); library(DT)
```

---

## ğŸ“ 0. ë°ì´í„° ë¡œë“œ ë° í™˜ê²½ ì„¤ì •

```{r}
hmda_file <- "https://ffiec.cfpb.gov/data-browser/data/2023?category=lar-csv"
download.file(hmda_file, destfile = "2023_hmda_lar.csv", mode = "wb")
data_hmda <- fread("2023_hmda_lar.csv")
```

---

## 1.  Action Taken codes

```{r}

### a. description table
action_taken_desc <- data.table(
  action_taken = 1:8,
  description = c(
    "Loan originated (ëŒ€ì¶œ ì‹¤í–‰ë¨)",
    "Approved but not accepted (ìŠ¹ì¸ëìœ¼ë‚˜ ìˆ˜ë½ ì•ˆë¨)",
    "Application denied (ê±°ì ˆë¨)",
    "Withdrawn by applicant (ì‹ ì²­ì¸ì´ ì² íšŒí•¨)",
    "File closed for incompleteness (ì„œë¥˜ ë¯¸ë¹„ë¡œ íê¸°ë¨)",
    "Purchased loan (ì¸ìˆ˜í•œ ëŒ€ì¶œ)",
    "Preapproval denied (ì‚¬ì „ìŠ¹ì¸ ìš”ì²­ ê±°ì ˆë¨)",
    "Preapproval approved not accepted (ì‹¤í–‰ ì•ˆë¨)"
  )
)

### b. count by codes 
deny_yn <- data_hmda[, .(
  cnt = .N,
  amt = trunc(sum(loan_amount) / bn)
), by = 'action_taken'] %>%
  merge(action_taken_desc, by = "action_taken", all.x = TRUE) %>%
  mutate(
    pct_amt = round(amt / sum(amt) * 100, 1)  # ê³„ì‚° ë¨¼ì €
  ) %>% 
  adorn_totals('row', name='Total') %>% 
  mutate(
    cnt = comma(cnt),     # ì´í›„ í¬ë§·íŒ…
    amt = comma(amt)
  ) %>%
  select(
    code = action_taken,
    description,
    cnt,
    amt,
    pct_amt
  ) %>%
  arrange(code) 


output_deny_yn <- deny_yn
knitr::kable(output_deny_yn)
```

---

## 2. approval rate by race (rece is typo)

```{r}
by_rece_info <- data_hmda[grepl('1|2|3',action_taken), .(
  cnt = .N,
  amt = trunc(sum(loan_amount) / bn),
  mean_loan_amount=mean(loan_amount,na.rm=T),
  mean_grossAnnualIncome_inK=mean(income,na.rm=T)
), by = list(derived_race)
]

by_rece_approved <- data_hmda[action_taken=='1', .(
  app_cnt = .N,
  app_amt = trunc(sum(loan_amount) / bn),
  app_mean_loan_amount=mean(loan_amount,na.rm=T),
  app_mean_grossAnnualIncome_inK=mean(income,na.rm=T)
), by = list(derived_race)
]

by_rece_info_approved <- merge(by_rece_info,by_rece_approved, by='derived_race') %>% 
  mutate(app_pct_cnt=round(app_cnt/cnt*100,1),
         app_pct_amt=round(app_amt/amt*100,1),
         ) %>% 
  arrange(desc(cnt)) %>% 
  adorn_totals('row',name='Total')

output_by_rece_info_approved <- by_rece_info_approved

knitr::kable(output_by_rece_info_approved)
```

---

## 3. deny rate heat map by race and income quintile

```{r, fig.width=8, fig.height=5}
 2023ë…„ ë¶„ìœ„ ê²½ê³„ (ë‹¨ìœ„: ì²œ ë‹¬ëŸ¬ë¡œ ê°€ì • â€” HMDA income ë³€ìˆ˜ ê¸°ì¤€)
##
bucket_breaks <- c(-Inf, 18.98, 33.00, 47.91, 62.20, 80.61, 101.00, 127.30, 165.30, 234.90, Inf)
bucket_labels <- c(
  "P1 (bottom 10%)",
  "P2",
  "P3",
  "P4",
  "P5",
  "P6",
  "P7",
  "P8",
  "P9",
  "P10 (Top 10%)"
)

# binning by income quintile
data_hmda[, income_bucket := cut(
  income,                      # incomeì€ 1,000ë‹¬ëŸ¬ ë‹¨ìœ„ì—¬ì•¼ í•¨
  breaks = bucket_breaks,
  labels = bucket_labels,
  include.lowest = TRUE,
  right = FALSE
)]

####a. action_taken 1~3ë§Œ í•„í„°ë§ ë° ìŠ¹ì¸ ì—¬ë¶€ íŒŒìƒ ë³€ìˆ˜ ìƒì„±
dt_sub <- data_hmda[action_taken %in% 1:3]
dt_sub[, approval := fifelse(action_taken == 1, "approved", "denied")]

###b. derived_race ë° income_bucketë³„ denial rate ê³„ì‚°
denial_summary <- dt_sub[, .(
  n_total = .N,
  n_denied = sum(approval == "denied")
), by = .(derived_race, income_bucket)
][, denial_rate := round(n_denied / n_total * 100, 1)]

###c. ëŒ€ìƒ ì¸ì¢…ë§Œ í•„í„°ë§
target_races <- c("White", "Black or African American", "Asian", "Joint", "Race Not Available")
denial_summary <- denial_summary[derived_race %in% target_races]

###d. income_bucket ì •ë ¬ ìˆœì„œ ëª…ì‹œ (factor ë ˆë²¨ ê³ ì •)
bucket_levels <- c(
  "P1 (bottom 10%)", "P2", "P3", "P4", "P5",
  "P6", "P7", "P8", "P9", "P10 (Top 10%)"
)
denial_summary[, income_bucket := factor(income_bucket, levels = bucket_levels)]

denial_summary <- 
denial_summary %>% 
  mutate(derived_race=
           case_when(grepl('Available',derived_race)~"NA",
                     grepl('Black',derived_race)~"Black",
                     TRUE~derived_race))


###e. ggplot2ë¡œ íˆíŠ¸ë§µ ì‹œê°í™”
output_gr_denial_rate_income_bucket <- 
  ggplot(denial_summary , aes(x = income_bucket, y = derived_race, fill = denial_rate)) +
  geom_tile(color = "white") +
  geom_text(data = denial_summary[!is.na(denial_rate)],
            aes(label = paste0(denial_rate, "%")),
            size = 3) +
  scale_fill_gradient(low = "white", high = "red", name = "Denial Rate (%)", na.value = "grey90") +
  labs(
    title = "",
    x = "",
    y = ""
  ) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    legend.position = "none" 
  )
getwd()
ggsave( 'output_gr_denial_rate_income_bucket.png',
        output_gr_denial_rate_income_bucket)

```

---

## 4. ìƒí’ˆ ìœ í˜• ë¶„ì„

### 4.1 ìƒí’ˆë³„ ìŠ¹ì¸ ëŒ€ì¶œ ê±´ìˆ˜ ë° ë¹„ì¤‘

```{r}
##4.1 originated, loan purpose ------------
##Convert loans under conforming loan limit and not FHA, VA loans to Conforming
##loans conventional but not under the limit become non-conforming

data_hmda <- 
data_hmda[, derived_loan_product_type := case_when(
  conforming_loan_limit == "C" & str_detect(derived_loan_product_type, "Conventional") ~ 
    str_replace(derived_loan_product_type, "Conventional", "Conforming"),
  str_detect(derived_loan_product_type, "Conventional") ~ 
    str_replace(derived_loan_product_type, "Conventional", "Non-conforming"),
  TRUE ~ derived_loan_product_type
)]

by_product_type  <- data_hmda[action_taken=='1', .(
  cnt = .N,
  amt = trunc(sum(loan_amount) / bn)
), by = 'derived_loan_product_type'] 

by_loan_purpose <- data_hmda[action_taken=='1', .(
  cnt = .N,
  amt = trunc(sum(loan_amount) / bn)
), by = list(derived_loan_product_type,loan_purpose=
               case_when(grepl('1',loan_purpose)~"Purchase",
                         grepl('3',loan_purpose)~"Refinance",
                         TRUE~"Other")
                  )
]

by_loan_purpose_summary <- by_loan_purpose %>% 
  group_by(derived_loan_product_type) %>% 
  mutate(pct=round(cnt/sum(cnt)*100,1)) %>% 
  dcast(derived_loan_product_type~loan_purpose, value.var='pct')

output_by_product_type <- by_product_type %>% 
  left_join(by_loan_purpose_summary) %>% 
  select(derived_loan_product_type,cnt,amt) %>% 
  mutate(pct_tot_cnt=round(cnt/sum(cnt)*100,1),
         pct_tot_amt=round(amt/sum(amt)*100,1)) %>% 
  mutate(cntpct=paste0(format(cnt,big.mark=','),"(",pct_tot_cnt,")"),
         amtpct=paste0(format(amt,big.mark=','),"(",pct_tot_amt,")")) %>% 
  arrange(derived_loan_product_type) 


```

### 4.2 ëŒ€ì¶œ ì¡°ê±´ í†µê³„

```{r}

# a. í•„í„°ë§
data_hmda_primary <- data_hmda[action_taken == '1']

# b. íŒŒìƒë³€ìˆ˜ ìƒì„± (by reference)
data_hmda_primary[, product_type_large := str_remove_all(derived_loan_product_type, ':.*$')]


data_hmda_primary[, loan_amount := as.numeric(loan_amount)]
data_hmda_primary[, interest_rate := as.numeric(interest_rate)]
data_hmda_primary[, origination_charges := as.numeric(origination_charges)]


# ë ˆë²¨ ìˆœì„œ ìˆ˜ë™ ì •ì˜
dti_levels <- c(
  "<20%", "20%-<30%", "30%-<36%",
  "36", "37", "38", "39", "40", "41", "42", "43", "44", "45", "46", "47", "48", "49",
  "50%-60%", ">60%", 
  "Exempt"
)

age_levels <- c("<25", "25-34", "35-44", "45-54", "55-64", "65-74", ">74", "8888")



# ìˆœì„œëŒ€ë¡œ factorë¡œ ë³€í™˜
data_hmda_primary[, debt_to_income_ratio := factor(debt_to_income_ratio, levels = dti_levels)]

data_hmda_primary[, applicant_age  := factor(applicant_age , levels = age_levels)]



# í†µê³„ ìš”ì•½ ê³„ì‚°
###a. ë¶„ì„ ëŒ€ìƒ ë³€ìˆ˜ ëª©ë¡
measure_vars <- c("loan_amount", "interest_rate", "origination_charges")

###b. ê¸´ í˜•ì‹ìœ¼ë¡œ melt
long_dt <- melt(
  data_hmda_primary,
  id.vars = "product_type_large",
  measure.vars = measure_vars,
  variable.name = "variable",
  value.name = "value"
)

###c. ê·¸ë£¹ë³„ ìƒìœ„ 1% ì»·ì˜¤í”„ê°’ ê³„ì‚°
q99 <- long_dt[, .(cutoff = quantile(value, 0.99, na.rm = TRUE)), by = .(product_type_large, variable)]

###d. cutoff ê¸°ì¤€ìœ¼ë¡œ í•„í„°ë§ëœ ë°ì´í„° ê²°í•©
long_dt_trim <- merge(long_dt, q99, by = c("product_type_large", "variable"))
long_dt_trim <- long_dt_trim[value <= cutoff]




###e. í†µê³„ ìš”ì•½ + í¬ë§· ì ìš© (ê²°ê³¼ëŠ” ëª¨ë‘ characterë¡œ ê°•ì œ í†µì¼)
summary_stats_loanprofile <- long_dt[, {
  x <- if (variable %in% c("loan_amount", "origination_charges")) trunc(value) else value
  
  mean_val   <- if (variable %in% c("loan_amount", "origination_charges")) 
    comma(trunc(weighted.mean(x,by=loan_amount, na.rm = TRUE))) else 
        format(round(weighted.mean(x,x,by=loan_amount, na.rm = TRUE), 3), nsmall = 3)
  p5_val     <- if (variable %in% c("loan_amount", "origination_charges")) comma(trunc(quantile(x, 0.05, na.rm = TRUE))) else format(round(quantile(x, 0.05, na.rm = TRUE), 3), nsmall = 3)
  p25_val    <- if (variable %in% c("loan_amount", "origination_charges")) comma(trunc(quantile(x, 0.25, na.rm = TRUE))) else format(round(quantile(x, 0.25, na.rm = TRUE), 3), nsmall = 3)
  med_val    <- if (variable %in% c("loan_amount", "origination_charges")) comma(trunc(quantile(x, 0.5, na.rm = TRUE)))  else format(round(quantile(x, 0.5, na.rm = TRUE), 3), nsmall = 3)
  p75_val    <- if (variable %in% c("loan_amount", "origination_charges")) comma(trunc(quantile(x, 0.75, na.rm = TRUE))) else format(round(quantile(x, 0.75, na.rm = TRUE), 3), nsmall = 3)
  p95_val    <- if (variable %in% c("loan_amount", "origination_charges")) comma(trunc(quantile(x, 0.95, na.rm = TRUE))) else format(round(quantile(x, 0.95, na.rm = TRUE), 3), nsmall = 3)
  na_val     <- format(sum(is.na(x)), big.mark = ",")
  total_val  <- format(.N, big.mark = ",")
  
  list(
    mean = mean_val,
    p5 = p5_val,
    p25 = p25_val,
    median = med_val,
    p75 = p75_val,
    p95 = p95_val,
    na_count = na_val,
    total_count = total_val
  )
}, by = .(product_type_large, variable)]


summary_stats_loanprofile_short <- summary_stats_loanprofile %>% 
  select(product_type_large,variable, mean) %>% 
  dcast(product_type_large~variable) 


output_summary_stats_loan_condition_profile <- summary_stats_loanprofile_short

knitr::kable(output_summary_stats_loan_condition_profile)

```

### 4.3 ë‹´ë³´ ë° ì°¨ì£¼ í†µê³„

```{r}
data_hmda_primary[, dti_num := case_when(
  str_detect(debt_to_income_ratio, '20%')     ~ 20,
  str_detect(debt_to_income_ratio, '36%')     ~ 33,
  str_detect(debt_to_income_ratio, '50%-')    ~ 55,
  str_detect(debt_to_income_ratio, '<30%')    ~ 25,
  str_detect(debt_to_income_ratio, '>60%')    ~ 61,
  TRUE ~ as.numeric(str_remove(debt_to_income_ratio, "[^0-9.]"))
)]

# age_num ìƒì„±
data_hmda_primary[, age_num := case_when(
  str_detect(applicant_age, '25')     ~ 29.5,
  str_detect(applicant_age, '35')     ~ 39.5,
  str_detect(applicant_age, '45')     ~ 49.5,
  str_detect(applicant_age, '55')     ~ 59.5,
  str_detect(applicant_age, '65')    ~ 69.5,
  str_detect(applicant_age, '8888')   ~ NA_real_,
  TRUE ~ as.numeric(str_remove(applicant_age, "\\D"))
)]

measure_vars_col <- c("property_value", 
                      "combined_loan_to_value_ratio",
                      "dti_num",
                      "age_num")

data_hmda_primary[,.(cnt=.N), by='debt_to_income_ratio']

long_dt_col <- melt(
  data_hmda_primary,
  id.vars = "product_type_large",
  measure.vars = measure_vars_col,
  variable.name = "variable",
  value.name = "value"
)

long_dt_col$value <- as.numeric(long_dt_col$value)

###c. ê·¸ë£¹ë³„ ìƒìœ„ 1% ì»·ì˜¤í”„ê°’ ê³„ì‚°
q99 <- long_dt_col[, .(cutoff = quantile(value, 0.99, na.rm = TRUE)), by = .(product_type_large, variable)]

###d. cutoff ê¸°ì¤€ìœ¼ë¡œ í•„í„°ë§ëœ ë°ì´í„° ê²°í•©
long_dt_col_trim <- merge(long_dt_col, q99, by = c("product_type_large", "variable"))
long_dt_col_trim <- long_dt_col_trim[value <= cutoff]



collateral_debtor <- long_dt_col_trim[, {
  
  x <-  as.numeric(value)

  mean_val   <- if (variable %in% c("property_value")) comma(trunc(weighted.mean(x, by=loan_amount,na.rm = TRUE))) else format(round(weighted.mean(x, by=loan_amount, na.rm = TRUE), 3), nsmall = 3)
  p5_val     <- if (variable %in% c("property_value")) comma(trunc(quantile(x, 0.05, na.rm = TRUE))) else format(round(quantile(x, 0.05, na.rm = TRUE), 3), nsmall = 3)
  p25_val    <- if (variable %in% c("property_value")) comma(trunc(quantile(x, 0.25, na.rm = TRUE))) else format(round(quantile(x, 0.25, na.rm = TRUE), 3), nsmall = 3)
  med_val    <- if (variable %in% c("property_value")) comma(trunc(quantile(x, 0.5, na.rm = TRUE)))  else format(round(quantile(x, 0.5, na.rm = TRUE), 3), nsmall = 3)
  p75_val    <- if (variable %in% c("property_value"))comma(trunc(quantile(x, 0.75, na.rm = TRUE))) else format(round(quantile(x, 0.75, na.rm = TRUE), 3), nsmall = 3)
  p95_val    <- if (variable %in% c("property_value")) comma(trunc(quantile(x, 0.95, na.rm = TRUE))) else format(round(quantile(x, 0.95, na.rm = TRUE), 3), nsmall = 3)
  na_val     <- format(sum(is.na(x)), big.mark = ",")
  total_val  <- format(.N, big.mark = ",")
  
  list(
    mean = mean_val,
    p5 = p5_val,
    p25 = p25_val,
    median = med_val,
    p75 = p75_val,
    p95 = p95_val,
    na_count = na_val,
    total_count = total_val
  )
}, by = .(product_type_large, variable)]


output_summary_stats_collateral_debtor <- collateral_debtor
knitr::kable(output_summary_stats_collateral_debtor)
```

### 4.4 LTV/DTI ë¹„ìœ¨ ë¶„í¬

```{r, fig.width=9, fig.height=6}

data_hmda_primary <- 
  setDT(data_hmda_primary)[!product_type_large=='FSA/RHS',]


# ë¶„ì„ ë³€ìˆ˜ ëª©ë¡
vars <- c("combined_loan_to_value_ratio","debt_to_income_ratio", "income", "applicant_age",
          "property_value")


make_density_plot_trimmed <- function(data, var, group_var = "product_type_large", 
                                      lower, 
                                      upper) {
  
  
  df <- data %>%
    filter(grepl("^-?\\d+(\\.\\d+)?$", .data[[var]])) %>%
    mutate(value = as.numeric(.data[[var]])) %>%
    filter(!is.na(value)) %>%
    group_by(.data[[group_var]]) %>%
    filter(
      value > quantile(value, probs = lower, na.rm = TRUE),
      value < quantile(value, probs = upper, na.rm = TRUE)
    )
  
  ggplot(df, aes(x = value)) +
    geom_density(fill = "steelblue", alpha = 0.6) +
    facet_wrap(as.formula(paste("~", group_var)), ncol = 1, scales = "free_y") +
    theme_minimal(base_size = 12) +
    labs(
      title = '',
      x = var,
      y = "Density"
    ) +
    theme(
      strip.text = element_text(face = "bold"),
      panel.grid = element_blank()
    )
}


density_combined_loan_to_value_ratio <- make_density_plot_trimmed(data_hmda_primary,
                                                             vars[1], lower = 0.01, upper = 0.99)

gc()

density_income <- make_density_plot_trimmed(data_hmda_primary, vars[3], lower = 0.01, upper = 0.95)


data_hmda_primary %>% 
  group_by(product_type_large) %>% 
  summarize(pct_999=quantile(income, probs=0.999, na.rm=T))

density_prop_val <- make_density_plot_trimmed(data_hmda_primary,vars[5], lower = 0.01, upper = 0.95)

###caterogrical(age, dti)
fn_make_bar_plot_by_group <- function(data, cat_var, group_var = "product_type_large") {
  library(dplyr)
  library(ggplot2)
  library(viridis)
  
  df <- data %>%
    filter(!is.na(.data[[cat_var]])) %>%
    group_by(.data[[group_var]], .data[[cat_var]]) %>%
    summarise(count = n(), .groups = "drop") %>%
    group_by(.data[[group_var]]) %>%
    mutate(pct = count / sum(count) * 100)
  
  ###a. category ì •ë ¬: ì „ì²´ count ê¸°ì¤€ ë†’ì€ ìˆœ
  # category_order <- df %>%
  #   group_by(.data[[cat_var]]) %>%
  #   summarise(total = sum(count), .groups = "drop") %>%
  #   arrange(desc(total)) %>%
  #   pull(!!sym(cat_var))
  # 
  # df[[cat_var]] <- factor(df[[cat_var]], levels = category_order)
  
  ###b. ì‹œê°í™”
  ggplot(df, aes(x = .data[[cat_var]], y = pct, fill = .data[[group_var]])) +
    geom_col(position = "dodge") +
    facet_wrap(as.formula(paste("~", group_var)), ncol = 1, scales = "free_y") +
    scale_fill_viridis_d(name = group_var) +
    theme_minimal(base_size = 12) +
    labs(
      title = paste0("ìƒí’ˆìœ í˜•ë³„ ", cat_var, " ë¹„ìœ¨ ë¶„í¬"),
      x = cat_var,
      y = "%"
    ) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      strip.text = element_text(face = "bold"),
      panel.grid = element_blank(),
      legend.position = "bottom"
    )
}

hist_dti <- fn_make_bar_plot_by_group(data_hmda_primary%>% 
                                        filter(!grepl('Exempt',debt_to_income_ratio)), "debt_to_income_ratio")

cnt_first_group <- data_hmda_primary%>% 
  filter(!grepl('Exempt',debt_to_income_ratio)) %>%
  group_by(product_type_large, debt_to_income_ratio) %>% 
  summarize(cnt=n()) %>% 
  filter(!is.na(debt_to_income_ratio)) %>% 
  group_by(product_type_large) %>% 
  mutate(tot=sum(cnt, na.rm=T),
         pct=cnt/tot*100) %>% 
  arrange(desc(pct)) %>% 
  filter(row_number()==1)

non_qm_pct <- data_hmda_primary%>% 
  filter(!grepl('Exempt',debt_to_income_ratio)) %>%
  mutate(very_high_dti_yn=ifelse( debt_to_income_ratio %in% 
                                    c(44:49, '50%-60%', '>60%'),"y","n")) %>% 
  group_by(product_type_large,very_high_dti_yn) %>% 
  summarize(cnt=n()) %>% 
  group_by(product_type_large) %>% 
  mutate(tot=sum(cnt),
         pct=cnt/tot)



hist_dbtr_age<- fn_make_bar_plot_by_group(data_hmda_primary %>% 
                                            filter(!grepl('8888',applicant_age)), "applicant_age")


most_large_age_dist <- 
  data_hmda_primary%>% 
  filter(!grepl('8888',applicant_age)) %>%
  group_by(product_type_large, applicant_age) %>% 
  summarize(cnt=n()) %>% 
  filter(!is.na(applicant_age)) %>% 
  group_by(product_type_large) %>% 
  mutate(tot=sum(cnt, na.rm=T),
         pct=cnt/tot*100) %>% 
  arrange(desc(pct)) %>% 
  filter(row_number()==1)

##ltv/dti matrix
###make ltv bucket 

# 1ë‹¨ê³„: ltv_trunc ë¨¼ì € ë”°ë¡œ ê³„ì‚°
data_hmda_primary[, `:=`(
  ltv_trunc = trunc(as.numeric(combined_loan_to_value_ratio))
)]

# 2ë‹¨ê³„: bucketë“¤ ê³„ì‚° (ltv_trunc ì‚¬ìš© ê°€ëŠ¥í•´ì§)
data_hmda_primary[, `:=`(
  ltv_bucket = case_when(
    is.na(ltv_trunc) ~ "NA",
    ltv_trunc < 50 ~ "~50",
    ltv_trunc <= 60 ~ "~60",
    ltv_trunc <= 70 ~ "~70",
    ltv_trunc <= 80 ~ "~80",
    ltv_trunc <= 90 ~ "~90",
    ltv_trunc <= 100 ~ "~100",
    TRUE ~ "100~"
  ),
  dti_bucket = case_when(
    debt_to_income_ratio %in% 36:39 ~ "36%-<40%",
    debt_to_income_ratio %in% 40:44 ~ "40%-<45%",
    debt_to_income_ratio %in% 45:49 ~ "45%-<50%",
    TRUE ~ as.character(debt_to_income_ratio)
  )
)]

data_hmda_primary_ltv_dti_pct <- data_hmda_primary[
  !is.na(ltv_bucket) & !is.na(dti_bucket) & !debt_to_income_ratio=='Exempt'  &
    !product_type_large=='FSA/RHS'
  , .(cnt = .N),
  by = .(product_type_large, ltv_bucket, dti_bucket)
][
  , pct := cnt / sum(cnt) * 100, by = product_type_large
]

data_hmda_primary_ltv_dti_pct[, 
                              ltv_bucket := factor(ltv_bucket, levels = c("~50",
                                                                                  "~60", 
                                                                                  "~70", 
                                                                                  "~80", 
                                                                                  "~90", 
                                                                                  "~100", 
                                                                                  "100~"))]
unique(data_hmda_primary_ltv_dti_pct$ltv_bucket)
data_hmda_primary_ltv_dti_pct[, 
                              dti_bucket := factor(dti_bucket, levels = c("<20%",
                                                                          "20%-<30%",
                                                                          "30%-<36%", 
                                                                          "36%-<40%",
                                                                          "40%-<45%",
                                                                          "45%-<50%",
                                                                          "50%-60%",
                                                                              ">60%")
                              )]

hmda_primary_ltv_dti_pct <- 
  ggplot(data_hmda_primary_ltv_dti_pct %>% 
           filter(!ltv_bucket == 'NA'), 
         aes(x = dti_bucket, y = ltv_bucket, fill = pct)) +
  geom_tile(color = "white") +
  scale_fill_gradient(
    low = "white", high = "red",
    name = "Percent (%)"
  ) +
  geom_text(data = data_hmda_primary_ltv_dti_pct %>% 
              filter(pct >5, !ltv_bucket == 'NA'),
            aes(label = trunc(pct)),
            color = "black", size = 3) +
  labs(
    title = "",
    x = "DTI Bin",
    y = "LTV Bin"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_wrap(~ product_type_large, ncol = 2)

knitr::include_graphics("hmda_primary_ltv_dti_pct.png")
```

---

## 5. ì—°êµ¬ ë™í–¥ ë¶„ì„ (CrossRef)

```{r}

res <- cr_works(query = "home mortgage disclosure act",
                sort = "relevance",
                limit = 1000)

# ë…¼ë¬¸ ì œëª© ì¶”ì¶œ
data_crf <- res$data%>% 
  select(container.title,
         issued,
         score,
         type,
         title,
         is.referenced.by.count,
         abstract
         ) %>% 
  dplyr::rename(container_title=container.title,
                referenced_count=is.referenced.by.count) %>% 
  mutate(referenced_count=as.numeric(referenced_count),
         score=as.numeric(score)) %>% 
  filter(type %in% c('journal-article','book','report') &
           as.numeric(substr(issued,1,4))>1980
         )
data_crf %>% mutate(pub_yr=substr(issued,1,4)) %>% 
  group_by(pub_yr) %>% summarize(cnt=n(),
                                 ref_cnt=mean(referenced_count,na.rm=T)) 


knitr::kable(output_pub_yr)
```

### í‚¤ì›Œë“œ Wordcloud

```{r, echo=FALSE, out.width="100%"}

# titleì„ í•œ ì¤„ì”© í† í°í™”
title_words <- data_crf %>%
  unnest_tokens(word, title) %>%                # ë‹¨ì–´ ë‹¨ìœ„ë¡œ ë¶„í•´
  filter(!word %in% stop_words$word) %>%        # ë¶ˆìš©ì–´ ì œê±° (ì˜ì–´ ê¸°ì¤€)
  filter(str_detect(word, "[a-z]"))             # ìˆ«ì/ê¸°í˜¸ ì œê±° (ì˜ì–´ ì•ŒíŒŒë²³ë§Œ í¬í•¨)

# ë‹¨ì–´ ë¹ˆë„ìˆ˜
title_word_count <- title_words %>%
  count(word, sort = TRUE)

library(wordcloud)
library(RColorBrewer)
set.seed(123)

title_word_count_wc <- 
  title_word_count %>% 
  arrange(-n) %>% 
  filter(row_number()>4 & row_number()<99)

png("wordcloud_title.png", width=1200, height=800)
wordcloud(
  words = title_word_count_wc$word,
  freq = title_word_count_wc$n,
  min.freq = 2,
  scale = c(4, 0.8),            # ê¸€ì í¬ê¸° ë¹„ìœ¨ ì¡°ì •
  max.words = 100,              # ìµœëŒ€ ë‹¨ì–´ ìˆ˜
  random.order = FALSE,         # ì¤‘ì‹¬ ë‹¨ì–´ ë¨¼ì € ë°°ì¹˜
  rot.per = 0.2,                # íšŒì „ ë¹„ìœ¨ (ì ê²Œ íšŒì „)
  colors = brewer.pal(8, "Dark2")
)

knitr::include_graphics("wordcloud_title.png")
```

---

## ğŸ”„ ì „ì²´ ë¶„ì„ ê²°ê³¼ ì €ì¥

```{r}

output_list <- mget(ls(pattern = "^output_"))
saveRDS(output_list, file = "output_list.rds")
```

---

## ğŸ“Œ ì°¸ê³  ë¬¸í—Œ

- [HMDA Official](https://ffiec.cfpb.gov/data-browser/)
- [CrossRef API](https://www.crossref.org/)
